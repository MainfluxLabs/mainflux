openapi: 3.0.1
info:
  title: Mainflux reader service
  description: HTTP API for reading messages in JSON and SenML formats.
  version: "1.0.0"

paths:
  /json:
    get:
      summary: Retrieves JSON messages
      security:
        - bearerAuth: []
        - thingAuth: []
      description: |
        Retrieves a list of JSON messages with optional filtering. Due to
        performance concerns, data is retrieved in subsets. The API readers must
        ensure that the entire dataset is consumed either by making subsequent
        requests, or by increasing the subset size of the initial request.
      tags:
        - json messages
      parameters:
        - $ref: "#/components/parameters/Publisher"
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Offset"
        - $ref: "#/components/parameters/Subtopic"
        - $ref: "#/components/parameters/Protocol"
        - $ref: "#/components/parameters/From"
        - $ref: "#/components/parameters/To"
        - $ref: "#/components/parameters/AggInterval"
        - $ref: "#/components/parameters/AggType"
        - $ref: "#/components/parameters/AggField"
      responses:
        '200':
          $ref: "#/components/responses/JSONMessagesPageRes"
        '400':
          description: Failed due to malformed query parameters.
        '401':
          description: Missing or invalid access token or thing key provided.
        '500':
          $ref: "#/components/responses/ServiceError"
    delete:
      summary: Delete JSON messages
      security:
        - bearerAuth: []
        - thingAuth: []
      description: |
        Deletes JSON messages for a publisher within the specified time range and optional filters.
      tags:
        - json messages
      parameters:
        - $ref: "#/components/parameters/Subtopic"
        - $ref: "#/components/parameters/Publisher"
        - $ref: "#/components/parameters/From"
        - $ref: "#/components/parameters/To"
      responses:
        '200':
          description: Messages successfully deleted.
        '400':
          description: Failed due to malformed query parameters.
        '401':
          description: Missing or invalid access token or thing key provided.
        '500':
          $ref: "#/components/responses/ServiceError"

  /json/{publisherId}:
    delete:
      summary: Delete JSON messages by publisher ID
      security:
        - bearerAuth: []
      description: |
        Deletes JSON messages for a specific publisher ID within the specified time range and optional filters.
      tags:
        - json messages
      parameters:
        - name: publisherId
          in: path
          required: true
          description: Publisher's unique identifier.
          schema:
            type: string
        - $ref: "#/components/parameters/Subtopic"
        - $ref: "#/components/parameters/Protocol"
        - $ref: "#/components/parameters/From"
        - $ref: "#/components/parameters/To"
      responses:
        '200':
          description: Messages successfully deleted.
        '400':
          description: Failed due to malformed query parameters.
        '401':
          description: Missing or invalid access token provided.
        '500':
          $ref: "#/components/responses/ServiceError"

  /json/search:
    post:
      summary: Search JSON messages across multiple publishers
      security:
        - bearerAuth: []
        - thingAuth: []
      description: |
        Executes multiple JSON message queries concurrently and returns
        results for each query. Each item in the request array accepts
        the same parameters as the GET /json endpoint.
      tags:
        - json messages
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: "#/components/schemas/JSONSearchRequest"
              minItems: 1
            example:
              - publisher: "f9b2815c-8d8f-44f0-a1fe-6d72f15f5021"
                limit: 10
                offset: 0
              - publisher: "a1b2c3d4-0000-1111-2222-333344445555"
                agg_type: "max"
                agg_interval: "day"
                agg_value: 1
                agg_fields: ["humidity", "temperature"]
                limit: 5

      responses:
        '200':
          description: All queries returned successfully.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/JSONSearchResultItem"
        '207':
          description: Some queries failed. Each result item contains its own error field.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/JSONSearchResultItem"
        '400':
          description: Failed due to malformed request body.
        '401':
          description: Missing or invalid access token or thing key provided.
        '500':
          description: All queries failed.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/JSONSearchResultItem"

  /senml:
    get:
      summary: Retrieves SenML messages
      security:
        - bearerAuth: []
        - thingAuth: []
      description: |
        Retrieves a list of SenML messages with optional filtering. Due to
        performance concerns, data is retrieved in subsets. The API readers must
        ensure that the entire dataset is consumed either by making subsequent
        requests, or by increasing the subset size of the initial request.
      tags:
        - senml messages
      parameters:
        - $ref: "#/components/parameters/Publisher"
        - $ref: "#/components/parameters/Limit"
        - $ref: "#/components/parameters/Offset"
        - $ref: "#/components/parameters/Name"
        - $ref: "#/components/parameters/Subtopic"
        - $ref: "#/components/parameters/Protocol"
        - $ref: "#/components/parameters/Value"
        - $ref: "#/components/parameters/BoolValue"
        - $ref: "#/components/parameters/StringValue"
        - $ref: "#/components/parameters/DataValue"
        - $ref: "#/components/parameters/Comparator"
        - $ref: "#/components/parameters/From"
        - $ref: "#/components/parameters/To"
        - $ref: "#/components/parameters/AggInterval"
        - $ref: "#/components/parameters/AggType"
        - $ref: "#/components/parameters/AggField"
      responses:
        '200':
          $ref: "#/components/responses/SenMLMessagesPageRes"
        '400':
          description: Failed due to malformed query parameters.
        '401':
          description: Missing or invalid access token or thing key provided.
        '500':
          $ref: "#/components/responses/ServiceError"
    delete:
      security:
        - bearerAuth: []
        - thingAuth: []
      summary: Delete SenML messages
      description: |
        Deletes SenML messages for a publisher within the specified time range.
      tags:
        - senml messages
      parameters:
        - $ref: "#/components/parameters/Publisher"
        - $ref: "#/components/parameters/Subtopic"
        - $ref: "#/components/parameters/From"
        - $ref: "#/components/parameters/To"
      responses:
        '200':
          description: Messages successfully deleted.
        '400':
          description: Failed due to malformed query parameters.
        '401':
          description: Missing or invalid access token or thing key provided.
        '500':
          $ref: "#/components/responses/ServiceError"

  /senml/{publisherId}:
    delete:
      summary: Delete SenML messages by publisher ID
      security:
        - bearerAuth: []
      description: |
        Deletes SenML messages for a specific publisher ID within the specified time range.
      tags:
        - senml messages
      parameters:
        - name: publisherId
          in: path
          required: true
          description: Publisher's unique identifier.
          schema:
            type: string
        - $ref: "#/components/parameters/Subtopic"
        - $ref: "#/components/parameters/Protocol"
        - $ref: "#/components/parameters/From"
        - $ref: "#/components/parameters/To"
      responses:
        '200':
          description: Messages successfully deleted.
        '400':
          description: Failed due to malformed query parameters.
        '401':
          description: Missing or invalid access token provided.
        '500':
          $ref: "#/components/responses/ServiceError"

  /senml/search:
    post:
      summary: Search SenML messages across multiple publishers
      security:
        - bearerAuth: []
        - thingAuth: []
      description: |
        Executes multiple SenML message queries concurrently and returns
        results for each query. Each item in the request array accepts
        the same parameters as the GET /senml endpoint.
      tags:
        - senml messages
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: "#/components/schemas/SenMLSearchRequest"
              minItems: 1
            example:
              - publisher: "4f611fd7-15d5-4575-b5d5-8c1075beb6e2"
                name: "temperature"
                limit: 5
              - publisher: "4f611fd7-15d5-4575-b5d5-8c1075beb6e2"
                name: "humidity"
                comparator: "gt"
                v: 60
                limit: 10

      responses:
        '200':
          description: All queries returned successfully.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SenMLSearchResultItem"
        '207':
          description: Some queries failed. Each result item contains its own error field.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SenMLSearchResultItem"
        '400':
          description: Failed due to malformed request body.
        '401':
          description: Missing or invalid access token or thing key provided.
        '500':
          description: All queries failed.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SenMLSearchResultItem"

  /json/export:
    get:
      summary: Export JSON messages
      security:
        - bearerAuth: []
      description: |
        Exports JSON messages with optional filtering and format conversion.
      tags:
        - json messages
      parameters:
        - $ref: "#/components/parameters/Publisher"
        - $ref: "#/components/parameters/ConvertFormat"
        - $ref: "#/components/parameters/Subtopic"
        - $ref: "#/components/parameters/Protocol"
        - $ref: "#/components/parameters/From"
        - $ref: "#/components/parameters/To"
        - $ref: "#/components/parameters/AggInterval"
        - $ref: "#/components/parameters/AggType"
        - $ref: "#/components/parameters/AggField"
      responses:
        '200':
          description: Export file created successfully.
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '400':
          description: Failed due to malformed query parameters.
        '401':
          description: Missing or invalid access token provided.
        '500':
          $ref: "#/components/responses/ServiceError"

  /senml/export:
    get:
      summary: Export SenML messages
      security:
        - bearerAuth: []
      description: |
        Exports SenML messages with optional filtering and format conversion.
      tags:
        - senml messages
      parameters:
        - $ref: "#/components/parameters/Publisher"
        - $ref: "#/components/parameters/ConvertFormat"
        - $ref: "#/components/parameters/Name"
        - $ref: "#/components/parameters/Subtopic"
        - $ref: "#/components/parameters/Protocol"
        - $ref: "#/components/parameters/Value"
        - $ref: "#/components/parameters/BoolValue"
        - $ref: "#/components/parameters/StringValue"
        - $ref: "#/components/parameters/DataValue"
        - $ref: "#/components/parameters/Comparator"
        - $ref: "#/components/parameters/From"
        - $ref: "#/components/parameters/To"
        - $ref: "#/components/parameters/AggInterval"
        - $ref: "#/components/parameters/AggType"
        - $ref: "#/components/parameters/AggField"
      responses:
        '200':
          description: Export file created successfully.
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '400':
          description: Failed due to malformed query parameters.
        '401':
          description: Missing or invalid access token provided.
        '500':
          $ref: "#/components/responses/ServiceError"

  /backup:
    get:
      summary: Retrieves backup of the readers service.
      security:
        - bearerAuth: []
      description: |
        Retrieves backup of the readers service. Backup is a JSON file that contains
        all JSON and SenML messages.
      tags:
        - backup
      responses:
        '200':
          description: Backup file created successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  json_messages:
                    type: array
                    items:
                      $ref: "#/components/schemas/JSONMessage"
                  senml_messages:
                    type: array
                    items:
                      $ref: "#/components/schemas/SenMLMessage"
        '400':
          description: Failed due to malformed query parameters.
        '401':
          description: Missing or invalid access token provided.
        '500':
          $ref: "#/components/responses/ServiceError"

  /restore:
    post:
      summary: Restores readers service from backup.
      security:
        - bearerAuth: []
      description: |
        Restores service from backup. Backup is a JSON file that contains
        all JSON and SenML messages that will be restored. Requires admin privileges.
      tags:
        - backup
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                json_messages:
                  type: array
                  items:
                    $ref: "#/components/schemas/JSONMessage"
                senml_messages:
                  type: array
                  items:
                    $ref: "#/components/schemas/SenMLMessage"
      responses:
        '200':
          description: Messages successfully restored.
        '400':
          description: Failed due to malformed query parameters.
        '401':
          description: Missing or invalid access token provided.
        '415':
          description: Unsupported content type.
        '500':
          $ref: "#/components/responses/ServiceError"
  /health:
    get:
      summary: Retrieves service health check info.
      security: []
      tags:
        - health
      responses:
        '200':
          $ref: "#/components/responses/HealthRes"
        '500':
          $ref: "#/components/responses/ServiceError"

  /metrics:
    get:
      summary: Prometheus metrics endpoint
      tags:
        - metrics
      responses:
        '200':
          description: Prometheus metrics in text format.
          content:
            text/plain:
              schema:
                type: string

components:
  schemas:
    SenMLMessage:
      type: object
      properties:
        publisher:
          type: string
          description: Publisher's unique identifier.
        protocol:
          type: string
          description: Protocol name.
        name:
          type: string
          description: Measured parameter name.
        unit:
          type: string
          description: Value unit.
        value:
          type: number
          description: Measured value in number.
        stringValue:
          type: string
          description: Measured value in string format.
        boolValue:
          type: boolean
          description: Measured value in boolean format.
        dataValue:
          type: string
          description: Measured value in binary format.
        valueSum:
          type: number
          description: Sum value.
        time:
          type: integer
          format: int64
          description: Time of measurement as Unix nanoseconds (since epoch)
          example: 1694012400123456789
        updateTime:
          type: number
          description: Time of updating measurement.
        subtopic:
          type: string
          description: Message subtopic.

    JSONMessage:
      type: object
      properties:
        publisher:
          type: string
          description: Publisher's unique identifier.
        protocol:
          type: string
          description: Protocol name.
        payload:
          type: object
          description: Payload of a JSON message.
        created:
          type: integer
          format: int64
          description: Time of measurement as Unix nanoseconds (since epoch)
          example: 1694012400123456789

        subtopic:
          type: string
          description: Message subtopic.

    JSONMessagesPage:
      type: object
      properties:
        total:
          type: number
          description: Total number of items that are present on the system.
        offset:
          type: number
          description: Number of items that were skipped during retrieval.
        limit:
          type: number
          description: Size of the subset that was retrieved.
        messages:
          type: array
          minItems: 0
          uniqueItems: true
          items:
            $ref: "#/components/schemas/JSONMessage"

    SenMLMessagesPage:
      type: object
      properties:
        total:
          type: number
          description: Total number of items that are present on the system.
        offset:
          type: number
          description: Number of items that were skipped during retrieval.
        limit:
          type: number
          description: Size of the subset that was retrieved.
        messages:
          type: array
          minItems: 0
          uniqueItems: true
          items:
            $ref: "#/components/schemas/SenMLMessage"

    JSONSearchRequest:
      type: object
      properties:
        publisher:
          type: string
          description: Publisher's unique identifier.
        offset:
          type: integer
          default: 0
        limit:
          type: integer
          default: 10
          maximum: 1000
        subtopic:
          type: string
        protocol:
          type: string
        from:
          type: integer
          format: int64
          description: Start time in nanoseconds.
        to:
          type: integer
          format: int64
          description: End time in nanoseconds.
        filter:
          type: string
        agg_interval:
          type: string
          enum: [minute, hour, day, week, month, year]
        agg_value:
          type: integer
          default: 1
        agg_type:
          type: string
          enum: [min, max, avg, count]
        agg_fields:
          type: array
          items:
            type: string
        dir:
          type: string
          enum: [asc, desc]
          default: desc

    SenMLSearchRequest:
      type: object
      properties:
        publisher:
          type: string
          description: Publisher's unique identifier.
        offset:
          type: integer
          default: 0
        limit:
          type: integer
          default: 10
          maximum: 1000
        name:
          type: string
        subtopic:
          type: string
        protocol:
          type: string
        v:
          type: number
        comparator:
          type: string
          enum: [eq, lt, le, gt, ge]
        vb:
          type: boolean
        vs:
          type: string
        vd:
          type: string
        from:
          type: integer
          format: int64
          description: Start time in nanoseconds.
        to:
          type: integer
          format: int64
          description: End time in nanoseconds.
        agg_interval:
          type: string
          enum: [minute, hour, day, week, month, year]
        agg_value:
          type: integer
          default: 1
        agg_type:
          type: string
          enum: [min, max, avg, count]
        agg_fields:
          type: array
          items:
            type: string
        dir:
          type: string
          enum: [asc, desc]
          default: desc

    JSONSearchResultItem:
      type: object
      properties:
        total:
          type: integer
          description: Total number of messages matching the query.
        messages:
          type: array
          items:
            $ref: "#/components/schemas/JSONMessage"
        error:
          type: string
          description: Error message if this particular query failed.

    SenMLSearchResultItem:
      type: object
      properties:
        total:
          type: integer
          description: Total number of messages matching the query.
        messages:
          type: array
          items:
            $ref: "#/components/schemas/SenMLMessage"
        error:
          type: string
          description: Error message if this particular query failed.

  parameters:
    Publisher:
      name: publisher
      description: Publisher's unique identifier.
      in: query
      schema:
        type: string
      required: false
    Limit:
      name: limit
      description: Size of the subset to retrieve.
      in: query
      schema:
        type: integer
        default: 10
        maximum: 200
        minimum: 1
      required: false
    Offset:
      name: offset
      description: Number of items to skip during retrieval.
      in: query
      schema:
        type: integer
        default: 0
        minimum: 0
      required: false
    Name:
      name: name
      description: SenML message name.
      in: query
      schema:
        type: string
      required: false
    Subtopic:
      name: subtopic
      description: Message subtopic.
      in: query
      schema:
        type: string
      required: false
    Protocol:
      name: protocol
      description: Protocol name.
      in: query
      schema:
        type: string
      required: false
    Value:
      name: v
      description: SenML message value (numeric).
      in: query
      schema:
        type: number
      required: false
    BoolValue:
      name: vb
      description: SenML message bool value.
      in: query
      schema:
        type: boolean
      required: false
    StringValue:
      name: vs
      description: SenML message string value.
      in: query
      schema:
        type: string
      required: false
    DataValue:
      name: vd
      description: SenML message data value.
      in: query
      schema:
        type: string
      required: false
    Comparator:
      name: comparator
      description: Value comparison operator.
      in: query
      schema:
        type: string
        default: eq
        enum:
          - eq
          - lt
          - le
          - gt
          - ge
      required: false
    From:
      name: from
      description: Start time in nanoseconds.
      in: query
      schema:
        type: number
      required: false
    To:
      name: to
      description: End time in nanoseconds.
      in: query
      schema:
        type: number
      required: false
    ConvertFormat:
      name: convert
      description: Format to convert the backup to.
      in: query
      schema:
        type: string
        default: json
        enum:
          - json
          - csv
      required: false
    AggInterval:
      name: agg_interval
      description: Aggregation interval for time-based grouping.
      in: query
      schema:
        type: string
      required: false
    AggType:
      name: agg_type
      description: Type of aggregation to perform (e.g., sum, avg, min, max).
      in: query
      schema:
        type: string
      required: false
    AggField:
      name: agg_field
      description: Field to aggregate on.
      in: query
      schema:
        type: string
      required: false

  responses:
    JSONMessagesPageRes:
      description: JSON messages retrieved successfully.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/JSONMessagesPage"
    SenMLMessagesPageRes:
      description: SenML messages retrieved successfully.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/SenMLMessagesPage"
    ServiceError:
      description: Unexpected server-side error occurred.
    HealthRes:
      description: Service Health Check.
      content:
        application/json:
          schema:
            type: object
            properties:
              status:
                type: string
              version:
                type: string
              commit:
                type: string
              description:
                type: string
              buildTime:
                type: string

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        * Users access: "Authorization: Bearer <user_token>"
    thingAuth:
      type: http
      scheme: bearer
      bearerFormat: uuid
      description: |
        * Things access: "Authorization: Thing <thing_key>"

